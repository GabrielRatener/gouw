<html>
	<head>
		<script type="text/javascript" src="socket.io/socket.io.js"></script>
		<title>GOUW</title>
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<script type="text/javascript" src="js/board.js"></script>
	</head>
	<body>
		<h3 id="title"><!-- title --></h3>
		<div id="everything_wrapper">
			<div id="sidebar">
				<ul id="users">
					<!-- gets filled with list of users -->
				</ul>

			</div>
			<div id="request">

			</div>
			<div id="game">
				<!-- all genneral stuff goes here -->

				<ul id="commands"></ul>
				<!-- canvas appears when game has been aggreed to -->
				<div id="board">
				</div>

				<div id="scores">
					<div id="white">
						<span class="title">White:</span><span class="value"></span>
					</div>
					<div id="black">
						<span class="title">White:</span><span class="value"></span>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">



			function qe(query){
				return document.querySelector(query);
			}

			function qes(query){
				return document.querySelectorAll(query);
			}

			function append(elem, stuff){
				if (stuff instanceof String){
					var node = document.createTextNode(append);
					elem.appendChild(node);
				}else if (stuff instanceof Node){
					elem.appendChild(stuff);
				}else if (stuff instanceof Array){
					for(var i = 0; i < stuff.length; i++){
						append(elem, stuff[i]);
					}
				}else{
					return false;
				}

				return true;
			}

			function tag(type, attributes, append){
				var ele = document.createElement(type);

				for(var k in attributes){
					ele[k] = attributes[k];
				}

				if (!append) return ele;

				var res = append(ele, append);
				if(res){
					return ele;
				}else return false;
			}

			function syncFactory(){
				var hash = {}, i = false;
				return function(num, func){
					if(i === false){
						i = num;
					}

					if(i === num){
						func(i);
						i += 1;

						while(hash.hasOwnProperty(i)){
							hash[i](i);
							delete hash[i];

							i += 1;
						}
					}else{
						if(num < i) return false;
						else{
							hash[i] = func;
						}
					}

					return true;
				}
			}

			var MY_NAME, MY_ID;

			var Title = (function(){
				var me = {};

				var TITLE = document.querySelector("#title"), naaaame;
				
				Object.defineProperty(me, "value", {
					"get": function(){
						return naaaame;
					},
					"set": function(val){
						var tx = document.createTextNode(val);
						TITLE.appendChild(tx);
						naaaame = val;
					}
				});

				return me;
			}());

			var Users = (function(){
				var me = {};
				var USERS = document.querySelector("#users");

				function listItem(info){
					var el = document.createElement("li");
					el.setAttribute("id", 'i' + info.socket);
					if(info.playing) el.setAttribute("class", "playing");

					el.innerHTML = info.name;
					el.onclick = function(){
						me.sendGameRequest(info.socket, {});
					}

					return el;
				}

				me.add = function(obj){
					if(obj instanceof Array){
						for(var i = 0; i < obj.length; i++){
							me.add(obj[i]);
						}
					}else{
						var el = listItem(obj);
						USERS.appendChild(el);
					}
				}

				me.erase = function(id){
					var li = USERS.querySelector('#i' + id);
					USERS.removeChild(li);

					return true;
				}

				me.sendGameRequest = function(id, params){
					SOCKET.emit('game_request',{
						"target": id,
						"parameters": params
					});
				}

				return me;
			}());


			var RequestDisplay = (function(){
				var me = {};

				me.onsubmit = function(){};

				var UL = tag("ul", {});

				var FORM = tag("form", {
					"action": "javascript: void(0);",
					"class": "hidden",
					"onsubmit": function(e){
						me.onsubmit(options, e);
					}
				}, UL);

				var target = false;

				var options = {};

				function addOption(keyval, id, name){
					var name = name || id,
						array = Object.keys(keyval);


					var head = tag("h3", {}, name);

					var tags = array.map(function(item, i){
						return tag("option", {
							"value": i
						}, item);
					});

					var select = tag("select", {
						"onchange":function(){
							var key = array[this.selectedIndex];
							options[id] = keyval[key];
						}
					}, tags);

					var li = tag("li", {
						"id": id,
						"select"
					}, [head, select]);

					UL.appendChild(li);
				}

				function addTextInput(id, name, placeholder){
					var name = name || id;

					var h3 = tag("h3", {}, name);

					var text = tag("textarea", {
						"placeholder": (!!placeholder) ? placeholder : "",
						"value": "",
						"onchange": function(e){
							options[id] = this.value
						}
					});

					var li = tag("li", {
						"id": id,
						"class": "text"
					}, [h3, text]);

					UL.appendChild(li);
				}

				me.show = function(){

				}

				me.hide = function(){

				}


				me.load = function(){

				}

				me.clean = function(){

				}

				me.attach = function(elem){
					elem.appendChild(FORM);
				}

				addOption({
					"9x9": [9,9],
					"13x13" [13,13],
					"19x19": [19,19]
				}, "board_size", "Board Size");

				addOption({
					"1": 1,
					"2": 2,
					"3": 3,
					"4": 4,
					"5": 5,
					"6": 6,
					"7": 7,
					"8": 8,
					"9": 9
				}, "handicap", "Handicap");

				addOption({
					"black": 0,
					"white": 1
				}, "color", "Color");

				addTextInput("message", "Add Message", "Hello, Would you like to play a game...");

				var submit = tag("li", {
					"id": "submit",
					"class": "submit"
				}, 	
					tag("input", {
						"type": "submit",
						"value": "Send Request"
					})
				);

				UL.appendChild(submit);

				return me;
			}());


			var GameDisplay = (function(){
				var me = {};

				var 
					score = [0,0],
					COMMANDS = qe("#game #commands"),
					BOARD = qe("#game #board"),


					// as usual black is 0, white is 1
					CAPTURES = [
						qe("#game #scores #black .value"),
						qe("#game #scores #white .value")
					];


				function addAction(id, title, func){
					var button = tag("input", {
						"type": "button",
						"value": title,
						"onclick": function(e){
							func(e);
						}
					});

					var li = tag("li", {
						"id": id
					}, button);
				}

				me.reset = function(){
					score = [0, 0];
					CAPTURES[0].innerHTML = 0;
					CAPTURES[1].innerHTML = 0;

					board.reset();
				}


				me.setScore = function(c, val){
					score[c] = val;
					CAPTURES[c].innerHTML = val;
				}

				me.addScore = function(c, val){
					var ns = score[c] + val;
					scores[c] = ns;
					CAPTURES[c].innerHTML = ns;
				}

				me.play = function(pt, color){
					board.play(pt, color);
				}


				me.show = function(){

				}

				me.hide = function(){
	
				}

				me.load = function(){

				}

				me.clean = function(){

				}

				// user defined methods (event handlers)
				me.onplay = function(e){};
				me.onpass = function(e){};
				me.onundorequest = function(e){};
				me.onresign = function(e){};

				return me;
			}());


			//namespace Display
			/*
			var Game = (function(){
				var me = {};
				var DISPLAY = document.querySelector("#display"),
					LIST = document.querySelector("#hand");

				var YourHand = (function(){
					var me = {};

					var LIST = document.querySelector("#yourhand");

					return me;
				}());

				var MyHand = (function(){
					var me = {};

					var LIST = document.querySelector("myhand#");

					return me;
				}());

				var IMG_URL = "cards/";

				// all protected functions go here

				function cardView(type){
					var el = document.createElement("li");
					el.attribute({
						"class": "cardview"
					});

					var image = new Image();
					image.src = IMG_URL + type;

					el.appendChild(image);
					return el;
				}

				me.match = function(opponent){
					var turn = false, hand = [];

					SOCKET.removeEventListener('play');
					SOCKET.on('play', function(data){
						opponent
					});
				}

				return me;
			}());
			*/

			var SOCKET = io.connect('http://' + document.location.hostname);
			SOCKET.on('info', function(info){
				Title.value = MY_NAME = info.me.name;
				MY_ID = info.me.socket;
				Users.add(info.online);
			});

			SOCKET.on('add_player', function(data){
				Users.add(data);
			});

			SOCKET.on('take_player', function(pid){
				Users.erase(pid);
			});



			SOCKET.on('game_request', function(data){
				console.log("game request received");
				SOCKET.emit('game_accept', data);
			});

			SOCKET.on('new_game', function(p){
				console.log("new game starting...");
				var board = new Board(
					document.querySelector("#board_wrapper"),
					{
						"size": p.size
					}
				),
				sync = syncFactory();

				BOARD = board;

				board.ontileclick = function(pt){
					SOCKET.emit('play', {
						"point": pt
					});
				}

				board.ontilehover = function(pt){
					this.putGhost(pt, p.color);
				}

				SOCKET.on('game_update', function(data){

					switch(data.type){
					case "play":
						sync(data.turn, function(){
							board.play(data.point, data.color);
							board.remove(data.captures);
						});
						break;
					case "pass":
						sync(data.turn, function(){
							//nothing to do here
						});
						break;
					case "resign": 
						sync(data.turn, function(){
							//
						});
						break;
					}
				});
			});


		</script>
	</body>
</html>