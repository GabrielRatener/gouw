<html>
	<head>
		<script type="text/javascript" src="socket.io/socket.io.js"></script>
		<title>GOUW</title>
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<script type="text/javascript" src="js/board.js"></script>
	</head>
	<body>
		<h3 id="title"><!-- title --></h3>
		<div id="everything_wrapper">
			<div id="sidebar">
				<ul id="users">
					<!-- gets filled with list of users -->
				</ul>

			</div>
			<div id="game">
				<!-- all genneral stuff goes here -->

				<!-- canvas appears when game has been aggreed to -->
				<div id="board_wrapper">
				</div>

				<!-- appears initially -->
				<form id="parameters">
				</form>
			</div>
		</div>
		<script type="text/javascript">

			function append(elem, stuff){
				if (stuff instanceof String){
					var node = document.createTextNode(append);
					elem.appendChild(node);
				}else if (stuff instanceof Node){
					elem.appendChild(stuff);
				}else if (stuff instanceof Array){
					for(var i = 0; i < stuff.length; i++){
						append(elem, stuff[i]);
					}
				}else{
					return false;
				}

				return true;
			}

			function tag(type, attributes, append){
				var ele = document.createElement(type);

				for(var k in attributes){
					ele[k] = attributes[k];
				}

				if (!append) return;

				var res = append(ele, append);
				if(res){
					return ele;
				}else return false;
			}

			function syncFactory(){
				var hash = {}, i = false;
				return function(num, func){
					if(i === false){
						i = num;
					}

					if(i === num){
						func(i);
						i += 1;

						while(hash.hasOwnProperty(i)){
							hash[i](i);
							delete hash[i];

							i += 1;
						}
					}else{
						if(num < i) return false;
						else{
							hash[i] = func;
						}
					}

					return true;
				}
			}

			var MY_NAME, MY_ID;

			var Title = (function(){
				var me = {};

				var TITLE = document.querySelector("#title"), naaaame;
				
				Object.defineProperty(me, "value", {
					"get": function(){
						return naaaame;
					},
					"set": function(val){
						var tx = document.createTextNode(val);
						TITLE.appendChild(tx);
						naaaame = val;
					}
				});

				return me;
			}());

			var Users = (function(){
				var me = {};
				var USERS = document.querySelector("#users");

				function listItem(info){
					var el = document.createElement("li");
					el.setAttribute("id", 'i' + info.socket);
					if(info.playing) el.setAttribute("class", "playing");

					el.innerHTML = info.name;
					el.onclick = function(){
						me.sendGameRequest(info.socket, {});
					}

					return el;
				}

				me.add = function(obj){
					if(obj instanceof Array){
						for(var i = 0; i < obj.length; i++){
							me.add(obj[i]);
						}
					}else{
						var el = listItem(obj);
						USERS.appendChild(el);
					}
				}

				me.erase = function(id){
					var li = USERS.querySelector('#i' + id);
					USERS.removeChild(li);

					return true;
				}

				me.sendGameRequest = function(id, params){
					SOCKET.emit('game_request',{
						"target": id,
						"parameters": params
					});
				}

				return me;
			}());


			var RequestDisplay = (function(){
				var me = {};

				me.onsubmit = function(){};

				var UL = tag("ul", {});

				var FORM = tag("form", {
					"action": "javascript: void(0);",
					"onsubmit": function(e){
						me.onsubmit(options, e);
					}
				}, UL);

				var target = false;

				var options = {};

				function addOption(keyval, id, name){
					var name = name|| id,
						array = Object.keys(keyval);


					var head = tag("h3", {}, name);

					var tags = array.map(function(item, i){
						return tag("option", {
							"value": i
						}, item);
					});

					var select = tag("select", {
						"onchange":function(){
							var key = array[this.selectedIndex];
							options[key] = keyval[key];
						}
					}, tags);

					var li = tag("li", {
						"id": id
					}, [head, select]);

					UL.appendChild(li);
				}

				me.show = function(){

				}

				me.hide = function(){

				}


				me.load = function(){

				}

				me.clean = function(){

				}

				return me;
			}());


			var GameDisplay = (function(){
				var me = {};

				me.show = function(){

				}

				me.hide = function(){
	
				}

				me.load = function(){

				}

				me.clean = function(){

				}

				return me;
			}());


			//namespace Display
			/*
			var Game = (function(){
				var me = {};
				var DISPLAY = document.querySelector("#display"),
					LIST = document.querySelector("#hand");

				var YourHand = (function(){
					var me = {};

					var LIST = document.querySelector("#yourhand");

					return me;
				}());

				var MyHand = (function(){
					var me = {};

					var LIST = document.querySelector("myhand#");

					return me;
				}());

				var IMG_URL = "cards/";

				// all protected functions go here

				function cardView(type){
					var el = document.createElement("li");
					el.attribute({
						"class": "cardview"
					});

					var image = new Image();
					image.src = IMG_URL + type;

					el.appendChild(image);
					return el;
				}

				me.match = function(opponent){
					var turn = false, hand = [];

					SOCKET.removeEventListener('play');
					SOCKET.on('play', function(data){
						opponent
					});
				}

				return me;
			}());
			*/

			var SOCKET = io.connect('http://' + document.location.hostname);
			SOCKET.on('info', function(info){
				Title.value = MY_NAME = info.me.name;
				MY_ID = info.me.socket;
				Users.add(info.online);
			});

			SOCKET.on('add_player', function(data){
				Users.add(data);
			});

			SOCKET.on('take_player', function(pid){
				Users.erase(pid);
			});



			SOCKET.on('game_request', function(data){
				console.log("game request received");
				SOCKET.emit('game_accept', data);
			});

			SOCKET.on('new_game', function(p){
				console.log("new game starting...");
				var board = new Board(
					document.querySelector("#board_wrapper"),
					{
						"size": p.size
					}
				),
				sync = syncFactory();

				BOARD = board;

				board.ontileclick = function(pt){
					SOCKET.emit('play', {
						"point": pt
					});
				}

				board.ontilehover = function(pt){
					this.putGhost(pt, p.color);
				}

				SOCKET.on('game_update', function(data){

					switch(data.type){
					case "play":
						sync(data.turn, function(){
							board.play(data.point, data.color);
							board.remove(data.captures);
						});
						break;
					case "pass":
						sync(data.turn, function(){
							//nothing to do here
						});
						break;
					case "resign": 
						sync(data.turn, function(){
							//
						});
						break;
					}
				});
			});


		</script>
	</body>
</html>